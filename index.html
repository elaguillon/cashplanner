<!DOCTYPE html>
<html lang="en" class="dark"> <!-- Dark mode enabled -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cash Planner</title>
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. Inter Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <!-- 3. Chart.js, date-fns, adapter, and annotation plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

    <!-- 4. Showdown (Markdown parser for chat) -->
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7); /* Darker for dark mode */
        }
        /* Ensure chart is responsive */
        #chart-container {
            position: relative;
            height: 50vh;
            min-height: 400px;
        }
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #27272a; /* dark:zinc-800 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #52525b; /* dark:zinc-600 */
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #71717a; /* dark:zinc-500 */
        }
        /* Custom class for date picker cells */
        .datepicker-day {
            transition: background-color 0.15s ease-in-out;
        }
        .datepicker-day:hover {
            background-color: #3f83f8; /* blue-500 */
            color: #ffffff;
        }
        .datepicker-day.other-month {
            color: #6b7280; /* gray-500 */
        }
        .datepicker-day.other-month:hover {
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
        }

        /* Chatbot Styles */
        #chat-ui-container {
            border: 1px solid #374151; /* dark:gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
        }
        #chat-history {
            height: 250px;
        }
        .chat-message {
            max-width: 80%;
        }
        .chat-message.user {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            align-self: flex-end;
        }
        .chat-message.model {
            background-color: #374151; /* dark:gray-700 */
            color: #d1d5db; /* dark:gray-300 */
            align-self: flex-start;
        }
        /* Markdown formatting */
        .chat-message.model p { margin-bottom: 0.5rem; }
        .chat-message.model ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }

    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8 dark:bg-gray-900">

    <!-- MAIN APP Container -->
    <div id="app-container" class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-8 dark:bg-gray-800">
        
        <!-- Header -->
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 dark:text-gray-100">Cash Planner</h1>
                <p class="text-gray-500 dark:text-gray-400">Visualize your income and expenses over time.</p>
            </div>
            <div class="flex items-center gap-4">
                <span id="header-username" class="text-lg font-semibold text-gray-700 dark:text-gray-300 hidden"></span>
                <button id="btn-logout" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 hidden">Logout</button>
                <button id="btn-login-header" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150 hidden">Login</button>
            </div>
        </header>

        <!-- Controls -->
        <div class="flex flex-col md:flex-row gap-4 items-center justify-between mb-6">
            <!-- Navigation Group -->
            <div class="flex items-center gap-2">
                <button id="btn-prev" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold p-3 rounded-full transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <span id="current-range" class="text-lg font-semibold text-gray-700 w-48 text-center dark:text-gray-300"></span>
                <button id="btn-next" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold p-3 rounded-full transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <button id="btn-today" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition duration-150 ml-2 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">Today</button>
            </div>
            
            <div class="flex items-center gap-4">
                <!-- View Toggles -->
                <div id="view-toggle-container" class="flex items-center bg-gray-200 rounded-lg p-1 dark:bg-gray-700">
                    <button id="btn-view-1m" class="btn-view active bg-white text-blue-600 shadow rounded-md py-2 px-4 font-medium text-sm transition-all dark:bg-blue-600 dark:text-white">1 Month</button>
                    <button id="btn-view-3m" class="btn-view text-gray-600 hover:text-gray-900 py-2 px-4 font-medium text-sm transition-all dark:text-gray-400 dark:hover:text-white">3 Months</button>
                    <button id="btn-view-1y" class="btn-view text-gray-600 hover:text-gray-900 py-2 px-4 font-medium text-sm transition-all dark:text-gray-400 dark:hover:text-white">1 Year</button>
                </div>

                <!-- Display Mode Toggles -->
                <div class="flex items-center bg-gray-200 rounded-lg p-1 dark:bg-gray-700">
                    <button id="btn-display-chart" class="btn-display active bg-white text-blue-600 shadow rounded-md py-2 px-4 font-medium text-sm transition-all dark:bg-blue-600 dark:text-white">Chart</button>
                    <button id="btn-display-calendar" class="btn-display text-gray-600 hover:text-gray-900 py-2 px-4 font-medium text-sm transition-all dark:text-gray-400 dark:hover:text-white">Calendar</button>
                </div>
            </div>
        </div>

        <!-- Chart -->
        <div id="chart-container" class="w-full mb-8">
            <canvas id="balanceChart"></canvas>
        </div>

        <!-- NEW Calendar Container -->
        <div id="calendar-container" class="w-full mb-8 hidden">
            <!-- Calendar Header (Days of Week) -->
            <div class="grid grid-cols-7 gap-px text-center text-xs font-semibold text-gray-500 dark:text-gray-400 border-b border-gray-300 dark:border-gray-700 pb-2 mb-2">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <!-- Calendar Grid -->
            <div id="calendar-grid" class="grid grid-cols-7 gap-px">
                <!-- Days will be injected here -->
            </div>
        </div>

        <!-- NEW Gemini Chat UI -->
        <div class="mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100 mb-4">Add with Gemini</h2>
            <div id="chat-ui-container" class="bg-gray-50 dark:bg-gray-900 rounded-xl overflow-hidden shadow-inner">
                <!-- Chat History -->
                <div id="chat-history" class="custom-scrollbar overflow-y-auto p-4 flex flex-col gap-3">
                    <!-- Chat messages will be injected here -->
                    <div class="chat-message model rounded-lg p-3">
                        <p>How can I help you plan your transactions?
                        <br>
                        Try saying: <em>"Add my $2000 salary every 2 weeks starting this Friday"</em> or <em>"Add $50 for groceries every Saturday"</em></p>
                    </div>
                </div>
                <!-- Chat Spinner -->
                <div id="chat-spinner" class="p-4 flex items-center gap-3 hidden">
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                    <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse"></div>
                </div>
                <!-- Chat Input -->
                <form id="chat-form" class="border-t border-gray-200 dark:border-gray-700 p-4">
                    <div class="flex items-center gap-3">
                        <input type="text" id="chat-input" placeholder="Chat with Gemini to add transactions..." class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                        <button type="submit" id="chat-submit-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold p-3 rounded-lg transition duration-150">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009.175 16V4.697l-4.243 4.243a1 1 0 101.414 1.414L10 6.828l3.652 3.652a1 1 0 101.414-1.414L10.826 4.828V16a1 1 0 00.928.996l5 1.428a1 1 0 001.17-1.41l-7-14z" />
                            </svg>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Transaction List -->
        <div>
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-gray-800 dark:text-gray-100">Transaction Rules</h2>
                <button id="btn-add-new-rule" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-150">
                    Add New Transaction
                </button>
            </div>
            <div id="transaction-list-container" class="custom-scrollbar max-h-96 overflow-y-auto bg-gray-50 p-4 rounded-lg border border-gray-200 dark:bg-gray-900 dark:border-gray-700">
                <!-- Transaction items will be injected here -->
                <p id="empty-list-msg" class="text-gray-500 text-center dark:text-gray-400">No transaction rules defined. Click 'Add New Transaction' or click on the chart to start.</p>
            </div>
        </div>

    </div>

    <!-- Modals (for the main app) -->

    <!-- Setup Modal -->
    <div id="setup-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl dark:bg-gray-800">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Welcome!</h2>
            <p class="text-gray-600 mb-6 dark:text-gray-300">Let's get started. Please enter your balances and today's date.</p>
            <form id="setup-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="starting-balance" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Starting Balance ($)</label>
                        <input type="number" id="starting-balance" value="5000" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" required>
                    </div>
                    <div>
                        <label for="safe-balance" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Safe Balance ($)</label>
                        <input type="number" id="safe-balance" value="1000" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Start Date</label>
                    <input type="text" id="start-date" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 cursor-pointer" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">
                    Start Forecasting
                </button>
            </form>
        </div>
    </div>

    <!-- Transaction Modal -->
    <div id="tx-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-lg p-8 rounded-xl shadow-2xl dark:bg-gray-800">
            <h2 id="tx-modal-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Add Transaction</h2>
            <form id="tx-form">
                <!-- Hidden fields for editing -->
                <input type="hidden" id="tx-id">
                <input type="hidden" id="tx-instance-date">

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Name -->
                    <div class="md:col-span-2">
                        <label for="tx-name" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Transaction Name</label>
                        <input type="text" id="tx-name" placeholder="e.g., Salary, Rent" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" required>
                    </div>
                    
                    <!-- Amount -->
                    <div>
                        <label for="tx-amount" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Amount ($)</label>
                        <input type="number" id="tx-amount" step="0.01" min="0" placeholder="100.00" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" required>
                    </div>

                    <!-- Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Type</label>
                        <div id="tx-type-group" class="flex flex-wrap items-center gap-x-4 gap-y-2 h-full">
                            <label class="flex items-center">
                                <input type="radio" name="tx-type" value="income" class="focus:ring-green-500 h-4 w-4 text-green-600 border-gray-300" checked>
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Income</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tx-type" value="expense" class="focus:ring-red-500 h-4 w-4 text-red-600 border-gray-300">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Expense</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tx-type" value="balance" class="focus:ring-yellow-500 h-4 w-4 text-yellow-600 border-gray-300">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Balance</span>
                            </label>
                        </div>
                    </div>

                    <!-- Start Date -->
                    <div class="md:col-span-2">
                        <label for="tx-date" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Date</label>
                        <input type="text" id="tx-date" readonly class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500 cursor-pointer" required>
                        <p id="tx-date-label" class="text-xs text-gray-500 mt-1 dark:text-gray-400">For a recurring transaction, this is the first date it occurs.</p>
                    </div>

                    <!-- Recurrence (NEW UI) -->
                    <div class="md:col-span-2 space-y-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Recurrence</label>
                        <div class="flex items-center gap-6">
                            <label class="flex items-center">
                                <input type="radio" name="tx-recurrence-toggle" value="none" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600" checked>
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Does not repeat</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="tx-recurrence-toggle" value="repeat" class="focus:ring-blue-500 h-4 w-4 text-blue-600 border-gray-300 dark:border-gray-600">
                                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Repeats every</span>
                            </label>
                        </div>
                        <div id="tx-recurrence-options" class="flex items-center gap-2 hidden">
                            <input type="number" id="tx-interval" value="1" min="1" class="w-20 px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                            <select id="tx-frequency" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600">
                                <option value="days">Days</option>
                                <option value="weeks">Weeks</option>
                                <option value="months">Months</option>
                            </select>
                        </div>
                    </div>

                </div>

                <!-- Buttons -->
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="btn-tx-delete" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 hidden">
                        Delete
                    </button>
                    <button type="button" id="btn-tx-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                        Cancel
                    </button>
                    <button type="submit" id="btn-tx-save" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150">
                        Save
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Day Transactions Modal -->
    <div id="day-tx-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl dark:bg-gray-800">
            <h2 id="day-tx-title" class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Transactions</h2>
            
            <!-- List of transactions for the day -->
            <div id="day-tx-list" class="max-h-64 overflow-y-auto space-y-3 mb-6">
                <!-- JS will populate this -->
            </div>
            
            <div class="space-y-3">
                <button id="btn-day-add-new" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">
                    Add Another Transaction
                </button>
                <button id="btn-day-close" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                    Close
                </button>
            </div>
        </div>
    </div>


    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl dark:bg-gray-800">
            <h2 id="confirm-title" class="text-2xl font-bold mb-4 text-gray-800 dark:text-gray-100">Confirm Change</h2>
            <p id="confirm-message" class="text-gray-600 mb-6 dark:text-gray-300">You are changing a recurring transaction. How would you like to apply this change?</p>
            
            <div class="space-y-4">
                <button id="btn-confirm-one" class="w-full text-left bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-3 px-4 rounded-lg transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                    Apply to this instance only
                    <span id="confirm-one-date" class="block text-sm text-gray-500 dark:text-gray-400"></span>
                </button>
                <button id="btn-confirm-all" class="w-full text-left bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium py-3 px-4 rounded-lg transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                    Apply to this and all future instances
                </button>
            </div>
            
            <div class="flex justify-end mt-8">
                 <button type="button" id="btn-confirm-cancel" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-6 rounded-lg transition duration-150 dark:bg-gray-700 dark:hover:bg-gray-600 dark:text-gray-200">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- NEW Date Picker Modal -->
    <div id="date-picker-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-xs p-6 rounded-xl shadow-2xl dark:bg-gray-800">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <button id="btn-date-prev" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
                <h3 id="date-picker-month-year" class="text-lg font-semibold text-gray-800 dark:text-gray-100"></h3>
                <button id="btn-date-next" class="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600 dark:text-gray-300" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <!-- Grid Header -->
            <div class="grid grid-cols-7 gap-1 text-center text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">
                <div>Su</div>
                <div>Mo</div>
                <div>Tu</div>
                <div>We</div>
                <div>Th</div>
                <div>Fr</div>
                <div>Sa</div>
            </div>
            <!-- Grid Body -->
            <div id="date-picker-grid" class="grid grid-cols-7 gap-1">
                <!-- Days will be injected here -->
            </div>
        </div>
    </div>

    <!-- Error/Message Toast -->
    <div id="toast" class="fixed bottom-8 right-8 z-50 bg-red-600 text-white py-3 px-6 rounded-lg shadow-lg hidden transition-all duration-300 transform translate-y-10 opacity-0">
        <span id="toast-message"></span>
    </div>

    <!-- Login Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl dark:bg-gray-800">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Login to Cash Planner</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Username</label>
                    <input type="text" id="login-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Password</label>
                    <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 mb-4">
                    Login
                </button>
                <p class="text-center text-gray-600 dark:text-gray-400">
                    Don't have an account? <a href="#" id="show-register-modal" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">Register here</a>
                </p>
            </form>
        </div>
    </div>

    <!-- Register Modal -->
    <div id="register-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 modal-backdrop hidden">
        <div class="bg-white w-full max-w-md p-8 rounded-xl shadow-2xl dark:bg-gray-800">
            <h2 class="text-2xl font-bold mb-6 text-gray-800 dark:text-gray-100">Register for Cash Planner</h2>
            <form id="register-form">
                <div class="mb-4">
                    <label for="register-username" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Username</label>
                    <input type="text" id="register-username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <div class="mb-6">
                    <label for="register-password" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Password</label>
                    <input type="password" id="register-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" required>
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150 mb-4">
                    Register
                </button>
                <p class="text-center text-gray-600 dark:text-gray-400">
                    Already have an account? <a href="#" id="show-login-modal" class="text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 font-medium">Login here</a>
                </p>
            </form>
        </div>
    </div>

    <script type="module">
        document.addEventListener('DOMContentLoaded', () => {
            // --- Imports ---
            const errorContainer = `<div style="position:fixed; top:0; left:0; right:0; bottom:0; display:flex; align-items:center; justify-content:center; background: #111827; color: #f87171; padding: 20px; text-align: center; font-family: 'Inter', sans-serif; font-size: 1.2rem;"><strong>Error:</strong> A critical library failed to load. Please check your internet connection and try refreshing the page. (Details: %ERROR%)</div>`;
            
            if (!window.Chart) {
                console.error("Fatal Error: Chart.js library (window.Chart) did not load.");
                document.body.innerHTML = errorContainer.replace('%ERROR%', 'Chart.js');
                return;
            }
            if (!window.dateFns || typeof window.dateFns.format !== 'function') {
                console.error("Fatal Error: date-fns library (window.dateFns) did not load correctly.");
                document.body.innerHTML = errorContainer.replace('%ERROR%', 'date-fns (incomplete)');
                return;
            }
            if (!window.Chart.registry.plugins.get('annotation')) {
                console.error("Fatal Error: Chart.js Annotation plugin did not auto-register.");
                document.body.innerHTML = errorContainer.replace('%ERROR%', 'Chart.js Annotation Plugin');
                return;
            }
            if (!window.showdown) {
                 console.error("Fatal Error: Showdown library (window.showdown) did not load.");
                document.body.innerHTML = errorContainer.replace('%ERROR%', 'Showdown');
                return;
            }

            // --- dateFns Destructuring ---
            const {
                format, parseISO, addDays, addWeeks, addMonths, startOfMonth, endOfMonth,
                startOfDay, eachDayOfInterval, isBefore, isAfter, isEqual, startOfYear, endOfYear, addYears,
                getDay, getDate, endOfWeek, startOfWeek, isSameMonth
            } = window.dateFns;

            // --- Global State ---
            const BACKEND_URL = 'httpd://cashplanner.vercel.app'; // Our Express backend
            let chartInstance = null;
            let startingBalance = null;
            let safeBalance = 0;
            let globalStartDate = null;
            let transactions = [];
            let currentDisplayMode = 'chart'; // 'chart' or 'calendar'
            let orangeGradient, redGradient;
            let currentView = { unit: 'months', value: 1, referenceDate: null };
            let confirmCallback = null;
            let editingTxContext = null; 
            let datePickerState = { referenceDate: new Date(), targetInputId: null };
            let markdownConverter = new showdown.Converter();
            let geminiChatHistory = []; // For the chatbot
            let accessToken = null; // Store JWT token
            let currentUserId = null;

            // --- DOM Elements ---
            const setupModal = document.getElementById('setup-modal');
            const txModal = document.getElementById('tx-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const dayTxModal = document.getElementById('day-tx-modal');
            const datePickerModal = document.getElementById('date-picker-modal');
            const setupForm = document.getElementById('setup-form');
            const txForm = document.getElementById('tx-form');
            const chartCanvas = document.getElementById('balanceChart').getContext('2d');
            const currentRangeEl = document.getElementById('current-range');
            const transactionListContainer = document.getElementById('transaction-list-container');
            const emptyListMsg = document.getElementById('empty-list-msg');
            const txAmountLabel = document.querySelector('label[for="tx-amount"]');
            const txRecurrenceOptions = document.getElementById('tx-recurrence-options');
            const chartContainer = document.getElementById('chart-container');
            const calendarContainer = document.getElementById('calendar-container');
            const calendarGrid = document.getElementById('calendar-grid');
            const viewToggleContainer = document.getElementById('view-toggle-container');
            
            // Chatbot DOM Elements
            const chatForm = document.getElementById('chat-form');
            const chatInput = document.getElementById('chat-input');
            const chatHistoryContainer = document.getElementById('chat-history');
            const chatSpinner = document.getElementById('chat-spinner');
            const chatSubmitBtn = document.getElementById('chat-submit-btn');
            
            // Auth DOM Elements
            const loginModal = document.getElementById('login-modal');
            const registerModal = document.getElementById('register-modal');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const showRegisterModalBtn = document.getElementById('show-register-modal');
            const showLoginModalBtn = document.getElementById('show-login-modal');
            const headerUsernameEl = document.getElementById('header-username');
            const btnLogout = document.getElementById('btn-logout');
            const btnLoginHeader = document.getElementById('btn-login-header');
            
            // --- Utility Functions ---
            const formatDate = (date) => format(date, 'yyyy-MM-dd');
            const formatShortDate = (date) => format(date, 'MMM d, yyyy');
            const generateUUID = () => crypto.randomUUID();
            
            const saveAuthToken = (token) => {
                localStorage.setItem('accessToken', token);
                accessToken = token;
            };
            
            const getAuthToken = () => {
                return localStorage.getItem('accessToken');
            };
            
            const removeAuthToken = () => {
                localStorage.removeItem('accessToken');
                accessToken = null;
                currentUserId = null;
            };

            const showToast = (message, isError = true) => {
                const toast = document.getElementById('toast');
                const toastMessage = document.getElementById('toast-message');
                
                toastMessage.textContent = message;
                toast.className = toast.className.replace(isError ? /bg-\w+-600/ : 'bg-red-600', isError ? 'bg-red-600' : 'bg-green-600');
                if (isError) {
                    toast.classList.remove('bg-green-600');
                    toast.classList.add('bg-red-600');
                } else {
                    toast.classList.remove('bg-red-600');
                    toast.classList.add('bg-green-600');
                }
                
                toast.classList.remove('hidden');
                setTimeout(() => {
                    toast.classList.remove('translate-y-10', 'opacity-0');
                    toast.classList.add('translate-y-0', 'opacity-100');
                }, 10);

                setTimeout(() => {
                    toast.classList.remove('translate-y-0', 'opacity-100');
                    toast.classList.add('translate-y-10', 'opacity-0');
                     setTimeout(() => {
                        toast.classList.add('hidden');
                    }, 300);
                }, 3000);
            };

            // --- Modal Management ---
            const openModal = (modal) => modal.classList.remove('hidden');
            const closeModal = (modal) => modal.classList.add('hidden');

            const openSetupModal = () => {
                let todayStr = new Date().toISOString().split('T')[0]; // yyyy-MM-dd
                try {
                    todayStr = formatDate(new Date());
                } catch (e) {
                    console.warn("dateFns not ready for openSetupModal, using native Date.");
                }
                document.getElementById('start-date').value = todayStr;
                openModal(setupModal);
            };

            const openTxModal = (context = {}) => {
                const { txId, instanceDate, clickDate } = context;
                
                txForm.reset();
                // Reset UI
                txAmountLabel.textContent = "Amount ($)";
                document.querySelector('input[name="tx-recurrence-toggle"][value="none"]').checked = true;
                txRecurrenceOptions.classList.add('hidden');
                document.querySelector('input[name="tx-recurrence-toggle"][value="repeat"]').disabled = false;
                
                const titleEl = document.getElementById('tx-modal-title');
                const deleteBtn = document.getElementById('btn-tx-delete');
                const dateLabel = document.getElementById('tx-date-label');
                const txDateInput = document.getElementById('tx-date');

                editingTxContext = null;
                deleteBtn.classList.add('hidden');
                document.querySelector('input[name="tx-type"][value="balance"]').parentElement.classList.add('hidden');


                if (txId) {
                    // Editing
                    const tx = transactions.find(t => t.id === txId);
                    if (!tx) {
                        showToast('Error: Could not find transaction.');
                        return;
                    }
                    
                    editingTxContext = { txId, instanceDate };
                    titleEl.textContent = 'Edit Transaction';
                    deleteBtn.classList.remove('hidden');
                    
                    document.getElementById('tx-id').value = tx.id;
                    document.getElementById('tx-instance-date').value = instanceDate;
                    document.getElementById('tx-name').value = tx.name;
                    document.getElementById('tx-amount').value = tx.amount;
                    document.querySelector(`input[name="tx-type"][value="${tx.type}"]`).checked = true;
                    txDateInput.value = tx.startDate;
                    dateLabel.textContent = "This is the first date this transaction occurs.";

                    // Set recurrence UI
                    if (tx.frequency === 'none') {
                        document.querySelector('input[name="tx-recurrence-toggle"][value="none"]').checked = true;
                        txRecurrenceOptions.classList.add('hidden');
                    } else {
                        document.querySelector('input[name="tx-recurrence-toggle"][value="repeat"]').checked = true;
                        txRecurrenceOptions.classList.remove('hidden');
                        document.getElementById('tx-interval').value = tx.interval;
                        document.getElementById('tx-frequency').value = tx.frequency;
                    }

                } else {
                    // Adding new
                    titleEl.textContent = 'Add Transaction';
                    document.querySelector('input[name="tx-type"][value="balance"]').parentElement.classList.remove('hidden');
                    txDateInput.value = clickDate ? clickDate : formatDate(new Date());
                    dateLabel.textContent = "For a recurring transaction, this is the first date it occurs.";
                }

                openModal(txModal);
            };
            
            const openDayTransactionsModal = (formattedDate, txs) => {
                const titleEl = document.getElementById('day-tx-title');
                const listEl = document.getElementById('day-tx-list');
                
                titleEl.textContent = `Transactions on ${formatShortDate(parseISO(formattedDate))}`;
                listEl.innerHTML = ''; // Clear list

                txs.forEach(tx => {
                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border dark:bg-gray-700 dark:border-gray-600';
                    
                    const colorClass = tx.type === 'income' ? 'text-green-500' : 'text-red-500';
                    const sign = tx.type === 'income' ? '+' : '-';

                    item.innerHTML = `
                        <div>
                            <p class="font-medium text-gray-800 dark:text-gray-100">${tx.name}</p>
                            <p class="text-sm ${colorClass} font-semibold">${sign}$${tx.amount.toFixed(2)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button class="btn-day-edit p-2 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300" title="Edit">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.96 7.96a2 2 0 01-1.06.586L3 16l.96-4.398a2 2 0 01.586-1.06l7.96-7.96zM12 5l-7 7 1.5 1.5L13.5 8 12 5z" /></svg>
                            </button>
                            <button class="btn-day-delete p-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300" title="Delete">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    `;

                    item.querySelector('.btn-day-edit').addEventListener('click', () => {
                        closeModal(dayTxModal);
                        openTxModal({ txId: tx.id, instanceDate: tx.instanceDate });
                    });
                    
                    item.querySelector('.btn-day-delete').addEventListener('click', () => {
                        handleDeleteFromList(tx.id, tx.instanceDate);
                    });

                    listEl.appendChild(item);
                });

                // Re-bind the "Add Another" button
                const btnAddNew = document.getElementById('btn-day-add-new');
                const btnAddNewClone = btnAddNew.cloneNode(true);
                btnAddNew.parentNode.replaceChild(btnAddNewClone, btnAddNew);
                btnAddNewClone.addEventListener('click', () => {
                    closeModal(dayTxModal);
                    openTxModal({ clickDate: formattedDate });
                });

                openModal(dayTxModal);
            };
            document.getElementById('btn-day-close').addEventListener('click', () => closeModal(dayTxModal));
            
            const openConfirmModal = (title, message, oneDate, callback) => {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                
                const btnOne = document.getElementById('btn-confirm-one');
                if (oneDate) {
                    btnOne.classList.remove('hidden');
                    document.getElementById('confirm-one-date').textContent = `On ${formatShortDate(parseISO(oneDate))}`;
                } else {
                    btnOne.classList.add('hidden');
                }
                
                confirmCallback = callback;
                openModal(confirmModal);
            };

            const openDatePickerModal = (targetInputId) => {
                datePickerState.targetInputId = targetInputId;
                const currentVal = document.getElementById(targetInputId).value;
                try {
                    datePickerState.referenceDate = currentVal ? parseISO(currentVal) : new Date();
                } catch (e) {
                    datePickerState.referenceDate = new Date();
                }
                renderDatePicker();
                openModal(datePickerModal);
            };

            const renderDatePicker = () => {
                const grid = document.getElementById('date-picker-grid');
                const monthYearEl = document.getElementById('date-picker-month-year');
                const ref = datePickerState.referenceDate;
                
                monthYearEl.textContent = format(ref, 'MMMM yyyy');
                grid.innerHTML = '';

                const monthStart = startOfMonth(ref);
                const monthEnd = endOfMonth(ref);
                const calStart = startOfWeek(monthStart);
                const calEnd = endOfWeek(monthEnd);

                const days = eachDayOfInterval({ start: calStart, end: calEnd });

                for (const day of days) {
                    const dayEl = document.createElement('button');
                    dayEl.type = 'button';
                    dayEl.className = 'datepicker-day w-10 h-10 flex items-center justify-center rounded-full font-medium text-sm text-gray-800 dark:text-gray-200';
                    dayEl.textContent = getDate(day);
                    
                    if (!isSameMonth(day, ref)) {
                        dayEl.classList.add('other-month');
                    }

                    dayEl.addEventListener('click', () => {
                        document.getElementById(datePickerState.targetInputId).value = formatDate(day);
                        closeModal(datePickerModal);
                    });

                    grid.appendChild(dayEl);
                }
            };

            // --- Transaction Logic ---
            const getOccurrencesInRange = (rangeStart, rangeEnd) => {
                const occurrences = {};
                rangeStart = startOfDay(rangeStart);
                rangeEnd = startOfDay(rangeEnd);

                const datesInRange = eachDayOfInterval({ start: rangeStart, end: rangeEnd });
                for (const date of datesInRange) {
                    occurrences[formatDate(date)] = [];
                }

                for (const tx of transactions) {
                    if (tx.userId !== currentUserId) continue; // Only show current user's transactions
                    const txStartDate = startOfDay(parseISO(tx.startDate));
                    
                    const ruleStartsAfterRange = isAfter(txStartDate, rangeEnd);
                    const ruleEndsBeforeRange = tx.endDate && isBefore(startOfDay(parseISO(tx.endDate)), rangeStart);
                    if (ruleStartsAfterRange || ruleEndsBeforeRange) continue;

                    if (tx.frequency === 'none') {
                        if (txStartDate >= rangeStart && txStartDate <= rangeEnd) {
                            occurrences[tx.startDate].push({ ...tx, instanceDate: tx.startDate });
                        }
                    } else {
                        let currentDate = txStartDate;
                        
                        if (isBefore(currentDate, rangeStart)) {
                            while (isBefore(currentDate, rangeStart)) {
                                try {
                                    if (tx.frequency === 'days') {
                                        currentDate = addDays(currentDate, tx.interval);
                                    } else if (tx.frequency === 'weeks') {
                                        currentDate = addWeeks(currentDate, tx.interval);
                                    } else if (tx.frequency === 'months') {
                                        currentDate = addMonths(currentDate, tx.interval);
                                    } else {
                                        break;
                                    }
                                } catch (e) {
                                    console.error("Error calculating next date in jump", e, tx);
                                    break;
                                }
                            }
                        }

                        while (currentDate <= rangeEnd) {
                            const formattedDate = formatDate(currentDate);
                            
                            const isSkipped = (tx.skipDates || []).includes(formattedDate);
                            const hasEnded = tx.endDate && isAfter(currentDate, startOfDay(parseISO(tx.endDate)));
                            
                            if (hasEnded) break;
                            
                            if (!isSkipped) {
                                const modification = (tx.modifications || {})[formattedDate];
                                if (modification) {
                                    occurrences[formattedDate].push({ ...tx, ...modification, id: tx.id, instanceDate: formattedDate, isModifiedInstance: true });
                                } else {
                                    occurrences[formattedDate].push({ ...tx, instanceDate: formattedDate });
                                }
                            }
                            
                            try {
                                if (tx.frequency === 'days') currentDate = addDays(currentDate, tx.interval);
                                else if (tx.frequency === 'weeks') currentDate = addWeeks(currentDate, tx.interval);
                                else if (tx.frequency === 'months') currentDate = addMonths(currentDate, tx.interval);
                                else break;
                            } catch (e) {
                                console.error("Error calculating next date", e, tx);
                                break;
                            }
                        }
                    }
                }
                return occurrences;
            };
            
            const getBalanceAtDate = (targetDate) => {
                if (!globalStartDate) return 0;
                targetDate = startOfDay(targetDate);
                if (isEqual(targetDate, globalStartDate)) return startingBalance;
                if (isBefore(targetDate, globalStartDate)) return startingBalance;

                const rangeEnd = addDays(targetDate, -1);
                const occurrences = getOccurrencesInRange(globalStartDate, rangeEnd);
                
                let balance = startingBalance;
                eachDayOfInterval({ start: globalStartDate, end: rangeEnd }).forEach(date => {
                    const dailyTxs = occurrences[formatDate(date)] || [];
                    if (dailyTxs.length === 0) return; // Skip if no transactions for the day
                    for (const tx of dailyTxs) {
                        const amount = parseFloat(tx.amount);
                        if (tx.type === 'income') balance += amount;
                        else if (tx.type === 'expense') balance -= amount;
                    }
                });
                return balance;
            };

            const calculateBalanceData = (rangeStart, rangeEnd) => {
                let currentBalance = getBalanceAtDate(rangeStart);
                const balanceData = [];
                const safeBalanceData = [];
                const annotations = [];
                let annotationLabelPositionToggle = 'start';
                
                const occurrences = getOccurrencesInRange(rangeStart, rangeEnd);
                
                eachDayOfInterval({ start: rangeStart, end: rangeEnd }).forEach(date => {
                    const formattedDate = formatDate(date);
                    const dailyTxs = occurrences[formattedDate] || [];
                    let dailyNetChange = 0;
                    
                    if (dailyTxs.length > 0) {
                        let labelNetChange = 0;
                        for (const tx of dailyTxs) {
                            const amount = parseFloat(tx.amount);
                            if (tx.type === 'income') labelNetChange += amount;
                            else if (tx.type === 'expense') labelNetChange -= amount;
                        }

                        const hasIncome = dailyTxs.some(t => t.type === 'income');
                        const hasExpense = dailyTxs.some(t => t.type === 'expense');
                        let borderColor = 'rgba(156, 163, 175, 0.5)';
                        let bgColor = 'rgba(156, 163, 175, 0.8)';

                        if (hasIncome && !hasExpense) {
                            borderColor = 'rgba(16, 185, 129, 0.5)';
                            bgColor = 'rgba(16, 185, 129, 0.8)';
                        } else if (!hasIncome && hasExpense) {
                            borderColor = 'rgba(239, 68, 68, 0.5)';
                            bgColor = 'rgba(239, 68, 68, 0.8)';
                        }
                        
                        const labelContent = dailyTxs.map(t => t.name).join(', ');
                        const netChangeString = `${labelNetChange >= 0 ? '+' : ''}$${labelNetChange.toFixed(2)}`;
                        const netChangeColor = labelNetChange >= 0 ? 'rgb(74, 222, 128)' : 'rgb(248, 113, 113)';
                        
                        annotations.push({
                            type: 'line',
                            scaleID: 'x',
                            value: date,
                            borderColor: borderColor,
                            borderWidth: 2,
                            borderDash: [6, 6],
                            label: {
                                content: [labelContent, netChangeString],
                                display: true,
                                position: annotationLabelPositionToggle,
                                backgroundColor: bgColor,
                                color: ['#FFFFFF', netChangeColor],
                                borderRadius: 4,
                                padding: 4,
                                font: [
                                    { size: 10, weight: 'normal' },
                                    { size: 11, weight: 'bold' }
                                ]
                            }
                        });
                        annotationLabelPositionToggle = (annotationLabelPositionToggle === 'start') ? 'end' : 'start';
                    }
                    
                    for (const tx of dailyTxs) {
                        const amount = parseFloat(tx.amount);
                        if (tx.type === 'income') dailyNetChange += amount;
                        else if (tx.type === 'expense') dailyNetChange -= amount;
                    }
                    
                    currentBalance += dailyNetChange;
                    balanceData.push({ x: date, y: currentBalance });
                    safeBalanceData.push({ x: date, y: safeBalance });
                });
                return { balanceData, safeBalanceData, annotations };
            };

            const renderCalendar = () => {
                if (!currentView.referenceDate) return;
                calendarGrid.innerHTML = '';
                const ref = currentView.referenceDate;
                const monthStart = startOfMonth(ref);
                const monthEnd = endOfMonth(ref);

                currentRangeEl.textContent = format(ref, 'MMMM yyyy');

                const occurrences = getOccurrencesInRange(monthStart, monthEnd);
                const daysInMonth = eachDayOfInterval({ start: monthStart, end: monthEnd });
                
                const firstDayOfWeek = getDay(monthStart);
                for (let i = 0; i < firstDayOfWeek; i++) {
                    calendarGrid.innerHTML += `<div class="bg-gray-50 dark:bg-gray-800/50 rounded-md"></div>`;
                }

                for (const day of daysInMonth) {
                    const formattedDate = formatDate(day);
                    const dayNumber = getDate(day);
                    const txsOnDay = occurrences[formattedDate] || [];

                    let txHtml = '';
                    if (txsOnDay.length > 0) {
                        txHtml = `<div class="mt-1 space-y-1 overflow-y-auto max-h-16">`;
                        txHtml += txsOnDay.map(tx => {
                            const bgColor = tx.type === 'income' ? 'bg-green-600' : 'bg-red-600';
                            return `<div class="${bgColor} text-white text-[10px] font-medium px-1.5 py-0.5 rounded-md truncate" title="${tx.name}">
                                        ${tx.name}
                                    </div>`;
                        }).join('');
                        txHtml += `</div>`;
                    }

                    const dayCell = document.createElement('div');
                    dayCell.className = 'calendar-day relative p-2 h-28 min-h-full bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700/50 rounded-md cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors';
                    dayCell.innerHTML = `
                        <span class="text-xs font-semibold text-gray-700 dark:text-gray-300">${dayNumber}</span>
                        ${txHtml}
                    `;
                    
                    dayCell.addEventListener('click', () => {
                        if (txsOnDay.length > 0) {
                            openDayTransactionsModal(formattedDate, txsOnDay);
                        } else {
                            openTxModal({ clickDate: formattedDate });
                        }
                    });

                    calendarGrid.appendChild(dayCell);
                }
            };
            
            const refreshDisplay = () => {
                if (!globalStartDate) return;
                if (currentDisplayMode === 'chart') {
                    renderChart();
                } else {
                    renderCalendar();
                }
                renderTransactionList();
            };

            // --- Transaction Handlers ---
            const handleSaveTransaction = async (txDataFromModal = null) => {
                let txData;

                if (txDataFromModal) {
                    txData = txDataFromModal;
                } else {
                    const id = document.getElementById('tx-id').value;
                    const instanceDate = document.getElementById('tx-instance-date').value;
                    const selectedMode = document.querySelector('input[name="tx-type"]:checked').value;
                    const rawAmount = parseFloat(document.getElementById('tx-amount').value);
                    
                    const recurrenceToggle = document.querySelector('input[name="tx-recurrence-toggle"]:checked').value;
                    let frequency = 'none';
                    let interval = 1;
                    
                    if (recurrenceToggle === 'repeat') {
                        frequency = document.getElementById('tx-frequency').value;
                        interval = parseInt(document.getElementById('tx-interval').value) || 1;
                    }

                    txData = {
                        id: id,
                        name: document.getElementById('tx-name').value,
                        amount: rawAmount,
                        type: selectedMode,
                        startDate: document.getElementById('tx-date').value,
                        frequency: frequency,
                        interval: interval,
                    };

                    if (!txData.name || isNaN(txData.amount) || (txData.amount <= 0 && selectedMode !== 'balance') || !txData.startDate) {
                        showToast('Please fill in all fields with valid values.');
                        return;
                    }
                    
                    if (selectedMode === 'balance') {
                        const balanceBefore = getBalanceAtDate(parseISO(txData.startDate));
                        const targetBalance = rawAmount;
                        const adjustment = targetBalance - balanceBefore;
                        
                        txData.type = (adjustment >= 0) ? 'income' : 'expense';
                        txData.amount = Math.abs(adjustment);
                        txData.frequency = 'none';
                        txData.interval = 1;
                        txData.name = txData.name || 'Balance Adjustment';
                    }
                }
  
                const id = txData.id;
                const instanceDate = document.getElementById('tx-instance-date').value; // Still need this for edits

                if (id) {
                    // --- Editing ---
                    const tx = transactions.find(t => t.id === id);
                    if (tx.frequency === 'none') {
                        Object.assign(tx, txData, { id: tx.id });
                        // API Call for update
                        try {
                            await callApi(`/transactions/${tx.id}`, 'PUT', txData);
                            finishSave();
                        } catch (error) {
                            showToast('Error updating transaction.');
                        }
                    } else {
                        openConfirmModal(
                            'Edit Recurring Transaction',
                            'You are editing a recurring transaction. How would you like to apply this change?',
                            instanceDate,
                            async (applyToAll) => {
                                try {
                                    if (applyToAll) {
                                        // Update the existing rule's end date and create a new one
                                        tx.endDate = formatDate(addDays(parseISO(instanceDate), -1));
                                        await callApi(`/transactions/${tx.id}`, 'PUT', tx);
                                        transactions.push({ ...txData, id: generateUUID(), endDate: null, skipDates: [], modifications: {} });
                                        await callApi('/transactions', 'POST', transactions[transactions.length - 1]); // Add new rule
                                    } else {
                                        if (!tx.modifications) tx.modifications = {};
                                        tx.modifications[instanceDate] = { name: txData.name, amount: txData.amount, type: txData.type };
                                        await callApi(`/transactions/${tx.id}`, 'PUT', tx);
                                    }
                                    finishSave();
                                } catch (error) {
                                    showToast('Error applying recurring transaction changes.');
                                }
                            }
                        );
                    }
                } else {
                    // --- Adding new ---
                    const newTx = { ...txData, id: generateUUID(), userId: currentUserId, endDate: null, skipDates: [], modifications: {} };
                    try {
                        await callApi('/transactions', 'POST', newTx);
                        transactions.push(newTx); // Add to local state after successful API call
                        finishSave(true);
                    } catch (error) {
                        showToast('Error adding transaction.');
                    }
                }
            };

            const handleDeleteTransaction = () => {
                const id = document.getElementById('tx-id').value;
                const instanceDate = document.getElementById('tx-instance-date').value;
                handleDeleteFromList(id, instanceDate);
            };
            
            const handleDeleteFromList = (id, instanceDate) => {
                const tx = transactions.find(t => t.id === id);
                if (!tx) return;

                if (tx.frequency === 'none') {
                    // API Call for delete
                    openConfirmModal(
                        'Delete Transaction',
                        'Are you sure you want to delete this one-time transaction?',
                        null, // No instance date for one-time
                        async (confirmed) => {
                            if (confirmed) {
                                try {
                                    await callApi(`/transactions/${tx.id}`, 'DELETE');
                                    transactions = transactions.filter(t => t.id !== id);
                                    finishDeleteFromList();
                                } catch (error) {
                                    showToast('Error deleting transaction.');
                                }
                            }
                        }
                    );
                } else {
                    openConfirmModal(
                        'Delete Recurring Transaction',
                        'You are deleting a recurring transaction. How would you like to apply this change?',
                        instanceDate,
                        async (applyToAll) => {
                            try {
                                if (applyToAll) {
                                    tx.endDate = formatDate(addDays(parseISO(instanceDate), -1));
                                    await callApi(`/transactions/${tx.id}`, 'PUT', tx);
                                } else {
                                    if (!tx.skipDates) tx.skipDates = [];
                                    tx.skipDates.push(instanceDate);
                                    await callApi(`/transactions/${tx.id}`, 'PUT', tx);
                                }
                                finishDeleteFromList();
                            } catch (error) {
                                showToast('Error applying recurring transaction changes.');
                            }
                        }
                    );
                }
            };
            
            const finishSave = (showSuccessToast = false) => {
                closeModal(txModal);
                closeModal(confirmModal);
                editingTxContext = null;
                confirmCallback = null;
                if (showSuccessToast) showToast("Transaction added!", false);
                refreshDisplay(); // Just refresh the UI, no save
            };
            
            const finishDeleteFromList = () => {
                closeModal(txModal);
                closeModal(dayTxModal);
                closeModal(confirmModal);
                confirmCallback = null;
                refreshDisplay(); // Just refresh the UI, no save
            };

            // --- Chart & Rendering ---
            const getChartDateRange = () => {
                const ref = currentView.referenceDate;
                let start, end;
                if (currentView.unit === 'months') {
                    if (currentView.value === 1) {
                        start = startOfMonth(ref);
                        end = endOfMonth(ref);
                    } else if (currentView.value === 3) {
                        start = startOfMonth(ref);
                        end = endOfMonth(addMonths(start, 2));
                    }
                } else if (currentView.unit === 'years') {
                    start = startOfYear(ref);
                    end = endOfYear(ref);
                }
                return { start: startOfDay(start), end: startOfDay(end) };
            };

            const renderChart = () => {
                if (!chartInstance || !globalStartDate) return;
                
                const { start, end } = getChartDateRange();
                
                if (currentView.unit === 'months' && currentView.value === 1) {
                    currentRangeEl.textContent = format(start, 'MMMM yyyy');
                } else {
                    currentRangeEl.textContent = `${format(start, 'MMM d, yyyy')} - ${format(end, 'MMM d, yyyy')}`;
                }
                
                const { balanceData, safeBalanceData, annotations } = calculateBalanceData(start, end);

                const didDip = balanceData.some(d => d.y < safeBalance);
                chartInstance.data.datasets[1].borderColor = didDip ? 'rgb(239, 68, 68)' : 'rgb(245, 158, 11)';
                chartInstance.data.datasets[1].backgroundColor = didDip ? redGradient : orangeGradient;

                chartInstance.data.labels = balanceData.map(d => d.x);
                chartInstance.data.datasets[0].data = balanceData;
                chartInstance.data.datasets[1].data = safeBalanceData;
                
                const belowSafeBalance = 'rgb(239, 68, 68)';
                const aboveSafeBalance = 'rgb(59, 130, 246)';
                const fillWarning = 'rgba(239, 68, 68, 0.1)';
                const fillStandard = 'rgba(59, 130, 246, 0.1)';

                chartInstance.data.datasets[0].segment = {
                    borderColor: ctx => (!ctx.p0 || !ctx.p1) ? aboveSafeBalance : (ctx.p0.parsed.y < safeBalance || ctx.p1.parsed.y < safeBalance ? belowSafeBalance : aboveSafeBalance)
                };
                chartInstance.data.datasets[0].fill = { target: '1', above: fillStandard, below: fillWarning };
                
                let timeUnit = 'day';
                if (currentView.value === 3) timeUnit = 'week';
                if (currentView.unit === 'years') timeUnit = 'month';
                chartInstance.options.scales.x.time.unit = timeUnit;
                chartInstance.options.plugins.annotation.annotations = annotations;
                chartInstance.update();
            };

            const renderTransactionList = () => {
                if (transactions.length === 0) {
                    emptyListMsg.classList.remove('hidden');
                    transactionListContainer.innerHTML = '';
                    transactionListContainer.appendChild(emptyListMsg);
                    return;
                }

                emptyListMsg.classList.add('hidden');
                transactionListContainer.innerHTML = '';

                const sortedTxs = [...transactions].sort((a, b) => isBefore(parseISO(a.startDate), parseISO(b.startDate)) ? -1 : 1);
                
                for (const tx of sortedTxs) {
                    const isRecurring = tx.frequency !== 'none';
                    const colorClass = tx.type === 'income' ? 'text-green-500' : 'text-red-500';
                    const sign = tx.type === 'income' ? '+' : '-';
                    let recurrenceText = 'One-time';
                    if (isRecurring) recurrenceText = `Every ${tx.interval} ${tx.frequency}`;
                    let statusText = tx.endDate ? `(Ends ${formatShortDate(parseISO(tx.endDate))})` : '';

                    const item = document.createElement('div');
                    item.className = 'flex items-center justify-between p-4 bg-white rounded-lg shadow-sm border border-gray-200 mb-3 dark:bg-gray-800 dark:border-gray-700';
                    item.innerHTML = `
                        <div class="flex-1 min-w-0">
                            <p class="text-base font-semibold text-gray-800 truncate dark:text-gray-100">${tx.name}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">
                                First occurs: ${formatShortDate(parseISO(tx.startDate))} ${statusText}
                            </p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${recurrenceText}</p>
                        </div>
                        <div class="flex items-center ml-4">
                            <span class="text-lg font-bold ${colorClass} mr-4">${sign}$${tx.amount.toFixed(2)}</span>
                            <button class="btn-edit-rule text-blue-600 hover:text-blue-800 p-2 rounded-md transition-colors dark:text-blue-400 dark:hover:text-blue-300" data-id="${tx.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-7.96 7.96a2 2 0 01-1.06.586L3 16l.96-4.398a2 2 0 01.586-1.06l7.96-7.96zM12 5l-7 7 1.5 1.5L13.5 8 12 5z" /></svg>
                            </button>
                        </div>
                    `;
                    item.querySelector('.btn-edit-rule').addEventListener('click', (e) => {
                        openTxModal({ txId: e.currentTarget.dataset.id, instanceDate: tx.startDate });
                    });
                    transactionListContainer.appendChild(item);
                }
            };

            const initializeChart = () => {
                if (chartInstance) chartInstance.destroy();

                const textColor = '#e5e7eb';
                const gridColor = 'rgba(156, 163, 175, 0.2)';

                orangeGradient = chartCanvas.createLinearGradient(0, 0, 0, 400);
                orangeGradient.addColorStop(0, 'rgba(245, 158, 11, 0.3)');
                orangeGradient.addColorStop(1, 'rgba(245, 158, 11, 0.05)');
                redGradient = chartCanvas.createLinearGradient(0, 0, 0, 400);
                redGradient.addColorStop(0, 'rgba(239, 68, 68, 0.3)');
                redGradient.addColorStop(1, 'rgba(239, 68, 68, 0.05)');
                
                chartInstance = new Chart(chartCanvas, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                        { 
                            label: 'Account Balance', 
                            data: [], 
                            tension: 0.1, 
                            pointRadius: 0, 
                            pointHitRadius: 10
                        },
                        { 
                            label: 'Safe Balance', 
                            data: [], 
                            borderColor: 'rgb(245, 158, 11)',
                            borderWidth: 2, 
                            borderDash: [5, 5], 
                            backgroundColor: orangeGradient,
                            fill: 'start',
                            pointRadius: 0, 
                            pointHitRadius: 0 
                        }
                    ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'day', tooltipFormat: 'MMM d, yyyy', displayFormats: { day: 'MMM d', week: 'MMM d', month: 'MMM yyyy' } },
                                grid: { display: false, borderColor: textColor },
                                ticks: { color: textColor, maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 15 }
                            },
                            y: {
                                min: 0,
                                grid: { color: gridColor, borderColor: textColor },
                                ticks: { color: textColor, callback: (value) => `$${value.toLocaleString()}` }
                            }
                        },
                        plugins: {
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    title: (tooltipItems) => formatShortDate(new Date(tooltipItems[0].parsed.x)),
                                    label: (tooltipItem) => {
                                        const label = tooltipItem.datasetIndex === 1 ? 'Safe Balance' : 'Balance';
                                        return `${label}: $${tooltipItem.parsed.y.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    }
                                }
                            },
                            legend: { display: false },
                            annotation: { annotations: [] }
                        },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false },
                        onClick: (evt) => {
                            const points = chartInstance.getElementsAtEventForMode(evt, 'nearest', { intersect: false }, true);
                            if (points.length) {
                                const clickedDate = chartInstance.data.labels[points[0].index];
                                const formattedDate = formatDate(clickedDate);
                                const dailyOccurrences = getOccurrencesInRange(clickedDate, clickedDate);
                                const txsOnDay = dailyOccurrences[formattedDate] || [];

                                if (txsOnDay.length > 0) {
                                    openDayTransactionsModal(formattedDate, txsOnDay);
                                } else {
                                    openTxModal({ clickDate: formattedDate });
                                }
                            }
                        }
                    },
                });
            };

            // --- Gemini Chatbot Logic ---

            const systemPrompt = `You are a helpful financial assistant for a cash planning app.
Your goal is to extract transaction details from the user's natural language input.
The current date is ${formatDate(new Date())}.
${currentUserId ? `The user is logged in with ID: ${currentUserId}.` : 'The user is not logged in.'}
You must respond ONLY in JSON format, using one of the two schemas provided.
Do not add any text before or after the JSON object.

Schema 1: ask_clarification
Use this schema if the user's request is missing any information needed to create a transaction (name, amount, type, date, frequency).
{
    "type": "ask_clarification",
    "question": "The question to ask the user."
}
Example: If the user says "Add my salary", you should ask "How much is your salary and when do you receive it?"
Example: If the user says "Add $100 for groceries", you should ask "Great. When should I add this $100 for groceries?"

Schema 2: add_transactions
Use this schema if you have all the necessary information to create one or more transactions.
{
    "type": "add_transactions",
    "transactions": [
        {
            "name": "Transaction Name",
            "amount": 100.00,
            "type": "income" | "expense",
            "startDate": "YYYY-MM-DD",
            "frequency": "none" | "days" | "weeks" | "months",
            "interval": 1
        }
    ]
}
Recurrence Rules:
- "none": A one-time transaction.
- "days": Repeats every 'interval' days.
- "weeks": Repeats every 'interval' weeks.
- "months": Repeats every 'interval' months.
- If no interval is specified, assume 1.
- "every friday" means { "frequency": "weeks", "interval": 1, "startDate": "YYYY-MM-DD" }
- "every 2 weeks" means { "frequency": "weeks", "interval": 2 }
- "monthly" means { "frequency": "months", "interval": 1 }
- "bi-monthly" means { "frequency": "months", "interval": 2 }
`;
            
            const addChatMessage = (role, text) => {
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${role} rounded-lg p-3`;
                
                if (role === 'model') {
                    messageEl.innerHTML = markdownConverter.makeHtml(text);
                } else {
                    messageEl.textContent = text;
                }
                
                chatHistoryContainer.appendChild(messageEl);
                chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight;
            };

            const callGemini = async (userPrompt) => {
                try {
                    const data = await callApi('/gemini-chat', 'POST', { chatHistory: geminiChatHistory, systemPrompt: systemPrompt });
                    const modelResponse = JSON.parse(data.candidates[0].content.parts[0].text);
                    geminiChatHistory.push({ role: "model", parts: [{ text: data.candidates[0].content.parts[0].text }] });
                    return modelResponse;
                } catch (error) {
                    console.error("Error calling backend for Gemini chat:", error);
                    return { type: 'ask_clarification', question: "Sorry, I'm having trouble connecting to Gemini right now. Please try again in a moment." };
                }
            };

            const handleChatSubmit = async (e) => {
                e.preventDefault();
                const prompt = chatInput.value.trim();
                if (!prompt) return;

                chatInput.value = '';
                chatSubmitBtn.disabled = true;
                chatSpinner.classList.remove('hidden');
                addChatMessage('user', prompt);

                const response = await callGemini(prompt);

                if (response.type === 'ask_clarification') {
                    addChatMessage('model', response.question);
                } else if (response.type === 'add_transactions') {
                    if (!response.transactions || !Array.isArray(response.transactions) || response.transactions.length === 0) {
                        console.error("AI returned 'add_transactions' but provided no valid transactions.", response);
                        addChatMessage('model', "Sorry, I thought I had enough information, but I'm missing the transaction details. Could you please provide them again?");
                    } else {
                        let summary = "Okay! I've added the following transactions:\n\n";
                        let success = true;

                        for (const tx of response.transactions) {
                            const newTx = {
                                id: null, // Will be set by handleSaveTransaction
                                name: tx.name,
                                amount: tx.amount,
                                type: tx.type,
                                startDate: tx.startDate,
                                frequency: tx.frequency,
                                interval: tx.interval || 1, // Default interval to 1 if missing
                            };

                            try {
                                // Validate date
                                parseISO(newTx.startDate);
                                // Add to app state (will be saved at the end)
                                transactions.push({ ...newTx, id: generateUUID(), endDate: null, skipDates: [], modifications: {} });
                                summary += `* **${tx.name}**: $${tx.amount} (${tx.type}) starting ${tx.startDate}\n`;
                            } catch (err) {
                                console.error("Error adding transaction from AI:", err, tx);
                                success = false;
                            }
                        }
                        
                        if(success) {
                            refreshDisplay(); // Just refresh, no save
                            addChatMessage('model', summary);
                            showToast("Transactions added!", false);
                        } else {
                            addChatMessage('model', "Sorry, I had an error adding those transactions. Some data might have been invalid.");
                        }
                    }
                }

                chatSpinner.classList.add('hidden');
                chatSubmitBtn.disabled = false;
                chatInput.focus();
            };

            // --- Event Listeners ---
            setupForm.addEventListener('submit', (e) => {
                e.preventDefault();
                startingBalance = parseFloat(document.getElementById('starting-balance').value);
                safeBalance = parseFloat(document.getElementById('safe-balance').value);
                globalStartDate = startOfDay(parseISO(document.getElementById('start-date').value));
                currentView.referenceDate = globalStartDate;
                
                if (isNaN(startingBalance) || isNaN(safeBalance) || !globalStartDate) {
                    showToast('Please enter a valid balance, safe balance, and start date.');
                    return;
                }
                
                if (!chartInstance) initializeChart();
                
                refreshDisplay();
                closeModal(setupModal);
            });

            txForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleSaveTransaction();
            });
            
            chatForm.addEventListener('submit', handleChatSubmit);
            
            document.getElementById('btn-tx-cancel').addEventListener('click', () => {
                closeModal(txModal);
                editingTxContext = null;
            });

            document.getElementById('btn-tx-delete').addEventListener('click', () => {
                handleDeleteTransaction();
            });

            // --- Other App Listeners ---
            document.getElementById('tx-type-group').addEventListener('change', (e) => {
                const selected = e.target.value;
                const toggleRepeat = document.querySelector('input[name="tx-recurrence-toggle"][value="repeat"]');
                if (selected === 'balance') {
                    txAmountLabel.textContent = 'Set New Balance ($)';
                    document.querySelector('input[name="tx-recurrence-toggle"][value="none"]').checked = true;
                    txRecurrenceOptions.classList.add('hidden');
                    toggleRepeat.disabled = true;
                } else {
                    txAmountLabel.textContent = 'Amount ($)';
                    toggleRepeat.disabled = false;
                }
            });
            document.querySelectorAll('input[name="tx-recurrence-toggle"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'repeat') {
                        txRecurrenceOptions.classList.remove('hidden');
                    } else {
                        txRecurrenceOptions.classList.add('hidden');
                    }
                });
            });
            document.getElementById('btn-confirm-one').addEventListener('click', () => {
                if (confirmCallback) confirmCallback(false);
            });
            document.getElementById('btn-confirm-all').addEventListener('click', () => {
                if (confirmCallback) confirmCallback(true);
            });
            document.getElementById('btn-confirm-cancel').addEventListener('click', () => {
                closeModal(confirmModal);
                confirmCallback = null;
            });
            document.getElementById('start-date').addEventListener('click', () => openDatePickerModal('start-date'));
            document.getElementById('tx-date').addEventListener('click', () => openDatePickerModal('tx-date'));
            document.getElementById('btn-date-prev').addEventListener('click', () => {
                datePickerState.referenceDate = addMonths(datePickerState.referenceDate, -1);
                renderDatePicker();
            });
            document.getElementById('btn-date-next').addEventListener('click', () => {
                datePickerState.referenceDate = addMonths(datePickerState.referenceDate, 1);
                renderDatePicker();
            });
            const updateView = (unit, value) => {
                currentView.unit = unit;
                currentView.value = value;
                if (unit === 'years') currentView.referenceDate = globalStartDate;
                document.querySelectorAll('.btn-view').forEach(btn => btn.classList.remove('active', 'bg-white', 'text-blue-600', 'shadow', 'dark:bg-blue-600', 'dark:text-white'));
                let activeBtn;
                if (unit === 'months' && value === 1) activeBtn = document.getElementById('btn-view-1m');
                else if (unit === 'months' && value === 3) activeBtn = document.getElementById('btn-view-3m');
                else if (unit === 'years') activeBtn = document.getElementById('btn-view-1y');
                if(activeBtn) activeBtn.classList.add('active', 'bg-white', 'text-blue-600', 'shadow', 'dark:bg-blue-600', 'dark:text-white');
                renderChart();
            };
            document.getElementById('btn-view-1m').addEventListener('click', () => updateView('months', 1));
            document.getElementById('btn-view-3m').addEventListener('click', () => updateView('months', 3));
            document.getElementById('btn-view-1y').addEventListener('click', () => updateView('years', 1));
            document.getElementById('btn-prev').addEventListener('click', () => {
                if (currentDisplayMode === 'chart') {
                    if (currentView.unit === 'months') currentView.referenceDate = addMonths(currentView.referenceDate, -currentView.value);
                    else if (currentView.unit === 'years') currentView.referenceDate = addYears(currentView.referenceDate, -1);
                } else {
                    currentView.referenceDate = addMonths(currentView.referenceDate, -1);
                }
                refreshDisplay();
            });
            document.getElementById('btn-next').addEventListener('click', () => {
                if (currentDisplayMode === 'chart') {
                    if (currentView.unit === 'months') currentView.referenceDate = addMonths(currentView.referenceDate, currentView.value);
                    else if (currentView.unit === 'years') currentView.referenceDate = addYears(currentView.referenceDate, 1);
                } else {
                    currentView.referenceDate = addMonths(currentView.referenceDate, 1);
                }
                refreshDisplay();
            });
            document.getElementById('btn-today').addEventListener('click', () => {
                currentView.referenceDate = startOfDay(new Date());
                if (currentDisplayMode !== 'chart') {
                    document.getElementById('btn-display-chart').click();
                } else {
                    refreshDisplay();
                }
                updateView('months', 1);
            });
            document.getElementById('btn-add-new-rule').addEventListener('click', () => {
                openTxModal();
            });
            document.getElementById('btn-display-chart').addEventListener('click', () => {
                currentDisplayMode = 'chart';
                chartContainer.classList.remove('hidden');
                calendarContainer.classList.add('hidden');
                viewToggleContainer.classList.remove('hidden');
                document.getElementById('btn-display-chart').classList.add('active', 'bg-white', 'text-blue-600', 'shadow', 'dark:bg-blue-600', 'dark:text-white');
                document.getElementById('btn-display-calendar').classList.remove('active', 'bg-white', 'text-blue-600', 'shadow', 'dark:bg-blue-600', 'dark:text-white');
                renderChart();
            });
            document.getElementById('btn-display-calendar').addEventListener('click', () => {
                currentDisplayMode = 'calendar';
                chartContainer.classList.add('hidden');
                calendarContainer.classList.remove('hidden');
                viewToggleContainer.classList.add('hidden');
                document.getElementById('btn-display-calendar').classList.add('active', 'bg-white', 'text-blue-600', 'shadow', 'dark:bg-blue-600', 'dark:text-white');
                document.getElementById('btn-display-chart').classList.remove('active', 'bg-white', 'text-blue-600', 'shadow', 'dark:bg-blue-600', 'dark:text-white');
                renderCalendar();
            });

            // --- Initialization ---
            const callApi = async (endpoint, method = 'GET', data = null) => {
                const headers = {
                    'Content-Type': 'application/json',
                };

                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }

                const config = {
                    method,
                    headers,
                };

                if (data) {
                    config.body = JSON.stringify(data);
                }

                const response = await fetch(`${BACKEND_URL}${endpoint}`, config);

                if (response.status === 401 || response.status === 403) {
                    // Token expired or invalid, force logout
                    showToast('Session expired. Please log in again.');
                    logout();
                    throw new Error('Unauthorized');
                }

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Something went wrong');
                }

                return response.json();
            };

            const fetchTransactions = async () => {
                try {
                    const data = await callApi('/transactions');
                    transactions = data; // Update global transactions array
                    refreshDisplay();
                } catch (error) {
                    console.error('Error fetching transactions:', error);
                    showToast('Failed to load transactions.');
                }
            };

            const initApp = async () => {
                accessToken = getAuthToken();
                if (accessToken) {
                    try {
                        // We need a way to get user ID from token without full validation on frontend
                        // For now, let's assume the token is valid and we can decode it (not secure for real apps)
                        const decodedToken = JSON.parse(atob(accessToken.split('.')[1]));
                        currentUserId = decodedToken.id;
                        headerUsernameEl.textContent = `Welcome, ${decodedToken.username}!`;
                        headerUsernameEl.classList.remove('hidden');
                        btnLogout.classList.remove('hidden');
                        btnLoginHeader.classList.add('hidden');

                        // Fetch initial data (starting balance, safe balance, start date) from user profile later
                        // For now, use defaults
                        startingBalance = 5000;
                        safeBalance = 1000;
                        globalStartDate = startOfDay(new Date());
                        currentView.referenceDate = globalStartDate;

                        if (!chartInstance) initializeChart();
                        await fetchTransactions(); // Fetch transactions for the authenticated user
                        closeModal(loginModal); // Close login if successful
                        closeModal(registerModal); // Close register if successful
                        closeModal(setupModal); // Close setup if successful
                    } catch (error) {
                        console.error('Token validation failed or user data fetch error:', error);
                        showToast('Invalid session. Please log in again.');
                        removeAuthToken();
                        headerUsernameEl.classList.add('hidden');
                        btnLogout.classList.add('hidden');
                        btnLoginHeader.classList.remove('hidden');
                        openModal(loginModal);
                    }
                } else {
                    headerUsernameEl.classList.add('hidden');
                    btnLogout.classList.add('hidden');
                    btnLoginHeader.classList.remove('hidden');
                    openModal(loginModal);
                }
            };

            const handleRegister = async (e) => {
                e.preventDefault();
                const username = document.getElementById('register-username').value;
                const password = document.getElementById('register-password').value;

                try {
                    await callApi('/register', 'POST', { username, password });
                    showToast('Registration successful! Please log in.', false);
                    closeModal(registerModal);
                    openModal(loginModal);
                } catch (error) {
                    showToast(error.message || 'Registration failed.');
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;

                try {
                    const data = await callApi('/login', 'POST', { username, password });
                    saveAuthToken(data.accessToken);
                    initApp(); // Re-initialize app after login
                    showToast('Logged in successfully!', false);
                } catch (error) {
                    showToast(error.message || 'Login failed.');
                }
            };

            const logout = () => {
                removeAuthToken();
                transactions = []; // Clear local transactions
                chartInstance.destroy(); // Destroy chart
                chartInstance = null;
                headerUsernameEl.classList.add('hidden');
                btnLogout.classList.add('hidden');
                btnLoginHeader.classList.remove('hidden');
                openModal(loginModal);
                showToast('Logged out successfully.', false);
            };

            // --- New Event Listeners for Auth ---
            registerForm.addEventListener('submit', handleRegister);
            loginForm.addEventListener('submit', handleLogin);
            showRegisterModalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                closeModal(loginModal);
                openModal(registerModal);
            });
            showLoginModalBtn.addEventListener('click', (e) => {
                e.preventDefault();
                closeModal(registerModal);
                openModal(loginModal);
            });
            btnLogout.addEventListener('click', logout);
            btnLoginHeader.addEventListener('click', () => openModal(loginModal));

            // Initial app load check
            initApp();
        });
    </script>
</body>
</html>